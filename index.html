<script>
  let mixer = null;
  let model = null;
  let currentAction = null;
  const actions = {};
  const loader = new AFRAME.THREE.GLTFLoader();

  AFRAME.registerComponent('my-anim', {
    init: function () {
      this.el.addEventListener('model-loaded', () => {
        model = this.el.getObject3D('mesh');
        const gltfModel = this.el.components['gltf-model'].model;

        mixer = new THREE.AnimationMixer(model);

        console.log('Анимации в основной модели:', gltfModel.animations);
        
        // Регистрируем все анимации из основной модели
        if (gltfModel.animations && gltfModel.animations.length > 0) {
          gltfModel.animations.forEach(clip => {
            actions[clip.name] = mixer.clipAction(clip, model);
            console.log('Зарегистрирована встроенная анимация:', clip.name);
          });
          
          // Автовоспроизведение первой анимации
          playBuiltInAnimation();
        } else {
          console.warn('В основной модели нет анимаций!');
        }
      });
    },
    tick: function (_, delta) {
      if (mixer) mixer.update(delta / 1000);
    }
  });

  function playBuiltInAnimation() {
    if (!actions || Object.keys(actions).length === 0) {
      console.warn("Нет доступных встроенных анимаций");
      return;
    }

    // Ищем анимацию с именем 'walk' или берем первую
    const clipName = actions['walk'] ? 'walk' : Object.keys(actions)[0];
    
    if (currentAction) currentAction.fadeOut(0.3);
    currentAction = actions[clipName];
    currentAction.reset().fadeIn(0.3).play();
    console.log("▶ Воспроизведена встроенная анимация:", clipName);
  }

  function playExternalAnimation(file) {
    if (!model || !mixer) {
      alert("Модель ещё не загружена. Подождите...");
      return;
    }

    console.log(`Загрузка внешней анимации из ${file}...`);
    
    loader.load(`assets/${file}`, 
      (gltf) => {
        // Проверяем наличие анимаций в файле
        if (!gltf.animations || gltf.animations.length === 0) {
          alert(`Файл ${file} не содержит анимаций!`);
          console.error(`В файле ${file} нет анимаций`);
          return;
        }

        // Берем первую анимацию из файла
        const clip = gltf.animations[0];
        console.log(`Найдена анимация в ${file}:`, clip.name || 'unnamed');
        
        // Создаем действие и привязываем к нашей модели
        const action = mixer.clipAction(clip, model);
        if (!action) {
          alert("Ошибка создания анимации");
          return;
        }

        // Плавный переход
        if (currentAction) currentAction.fadeOut(0.3);
        
        currentAction = action;
        currentAction.reset()
          .setEffectiveTimeScale(1) // нормальная скорость
          .setEffectiveWeight(1)    // полная интенсивность
          .fadeIn(0.3)
          .play();
          
        console.log(`▶ Успешно воспроизводится анимация из ${file}`);
      },
      undefined,
      (err) => {
        console.error("Ошибка загрузки:", err);
        alert(`Ошибка загрузки файла: ${file}\nПроверьте консоль`);
      }
    );
  }
</script>
