<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>WebXR Avatar with Three.js Animation</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/loaders/GLTFLoader.js"></script>
    <style>
      #menu {
        position: absolute;
        top: 20px;
        left: 20px;
        background: rgba(255, 255, 255, 0.9);
        padding: 10px 15px;
        border-radius: 10px;
        font-family: sans-serif;
        z-index: 999;
      }
      button {
        display: block;
        margin: 5px 0;
        padding: 8px 12px;
        font-size: 14px;
        cursor: pointer;
      }
    </style>
  </head>

  <body>
    <div id="menu">
      <h3>–ê–Ω–∏–º–∞—Ü–∏–∏</h3>
      <button onclick="playClip('walk')">üö∂ –•–æ–¥—å–±–∞ (–∏–∑ –º–æ–¥–µ–ª–∏)</button>
      <button onclick="playClipFromGLB('pointing.glb')">üëâ –£–∫–∞–∑–∞–Ω–∏–µ</button>
      <button onclick="playClipFromGLB('arm.glb')">üëã –ú–∞—Ö–∞–Ω–∏–µ</button>
    </div>

    <a-scene>
      <a-assets>
        <a-asset-item id="walkmanModel" src="assets/walkman.glb"></a-asset-item>
      </a-assets>

      <a-entity id="avatar" gltf-model="#walkmanModel" position="0 0 -2" scale="1 1 1" my-animation></a-entity>

      <a-sky color="#ECECEC"></a-sky>
      <a-light type="ambient" intensity="1.2"></a-light>
      <a-camera position="0 1.6 0" look-controls wasd-controls></a-camera>
    </a-scene>

    <script>
      let mixer, model, currentAction;
      const actions = {};
      const loader = new THREE.GLTFLoader();

      AFRAME.registerComponent("my-animation", {
        init: function () {
          this.el.addEventListener("model-loaded", () => {
            model = this.el.getObject3D("mesh");
            const gltf = this.el.components["gltf-model"].model;
            mixer = new THREE.AnimationMixer(model);

            // –ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∏–º–∞—Ü–∏–π –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–π –º–æ–¥–µ–ª–∏
            const clips = gltf.animations || [];
            console.log("Animations found in walkman.glb:", clips);
            
            clips.forEach((clip) => {
              // –ï—Å–ª–∏ –∞–Ω–∏–º–∞—Ü–∏—è –±–µ–∑ –∏–º–µ–Ω–∏, –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º –∏–º—è 'walk' –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
              if (!clip.name) clip.name = 'walk';
              actions[clip.name] = mixer.clipAction(clip);
              console.log("Registered animation:", clip.name);
            });

            // –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∏–º–∞—Ü–∏—é walk, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
            if (actions["walk"]) {
              playClip("walk");
            } else {
              console.warn("Animation 'walk' not found in model");
            }
          });
        },
        tick: function (time, delta) {
          if (mixer) mixer.update(delta / 1000);
        }
      });

      function playClip(name) {
        console.log("Attempting to play animation:", name);
        if (!actions[name]) {
          console.error(`Animation "${name}" not found in registered actions`);
          alert(`–ê–Ω–∏–º–∞—Ü–∏—è "${name}" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.`);
          return;
        }

        if (currentAction) {
          currentAction.fadeOut(0.3);
        }

        currentAction = actions[name];
        currentAction.reset().fadeIn(0.3).play();
        console.log(`Now playing animation: ${name}`);
      }

      function playClipFromGLB(filename) {
        console.log(`Loading external animation from: ${filename}`);
        if (!model || !mixer) {
          console.error("Model or mixer not ready");
          return;
        }

        loader.load(`assets/${filename}`, 
          (gltf) => {
            if (!gltf.animations || gltf.animations.length === 0) {
              console.error(`No animations found in ${filename}`);
              alert(`–§–∞–π–ª ${filename} –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∞–Ω–∏–º–∞—Ü–∏–π`);
              return;
            }

            console.log(`Loaded ${filename}, animations:`, gltf.animations);
            
            const clip = gltf.animations[0];
            // –ï—Å–ª–∏ –∞–Ω–∏–º–∞—Ü–∏—è –±–µ–∑ –∏–º–µ–Ω–∏, –∑–∞–¥–∞–µ–º –∏–º—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
            if (!clip.name) {
              clip.name = filename.replace('.glb', '');
              console.log(`Assigned name '${clip.name}' to unnamed animation`);
            }

            const action = mixer.clipAction(clip, model);
            
            if (currentAction) {
              currentAction.fadeOut(0.3);
            }

            currentAction = action;
            action.reset().fadeIn(0.3).play();
            console.log(`Now playing animation: ${clip.name}`);
          },
          undefined,
          (error) => {
            console.error(`Error loading ${filename}:`, error);
            alert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ ${filename}`);
          }
        );
      }
    </script>
  </body>
</html>
