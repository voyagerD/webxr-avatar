<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>–ê–Ω–∏–º–∞—Ü–∏–∏ —Å —Ä—É—á–Ω—ã–º bind</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/loaders/GLTFLoader.min.js"></script>
  <style>
    body { margin: 0; }
    #menu {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
      background: rgba(255, 255, 255, 0.9);
      padding: 10px;
      border-radius: 8px;
      font-family: sans-serif;
    }
    button {
      display: block;
      margin: 5px 0;
      padding: 6px 10px;
      font-size: 14px;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <div id="menu">
    <h3>–ê–Ω–∏–º–∞—Ü–∏–∏</h3>
    <button onclick="playBuiltInAnimation()">‚ñ∂ –•–æ–¥—å–±–∞ (–≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è)</button>
    <button onclick="playExternalAnimation('arm.glb')">üëã –ú–∞—Ö–∞–Ω–∏–µ</button>
    <button onclick="playExternalAnimation('pointing.glb')">üëâ –£–∫–∞–∑–∞–Ω–∏–µ</button>
  </div>

  <a-scene>
    <a-assets>
      <a-asset-item id="walkman" src="assets/walk_man.glb"></a-asset-item>
    </a-assets>

    <a-entity id="avatar"
              gltf-model="#walkman"
              position="0 0 -2"
              scale="1 1 1"
              my-anim></a-entity>

    <a-light type="ambient" intensity="1.2"></a-light>
    <a-light type="directional" intensity="0.6" position="1 2 1"></a-light>
    <a-camera position="0 1.6 2"></a-camera>
  </a-scene>

  <script>
    let mixer = null;
    let model = null;
    let skeleton = null;
    let currentAction = null;
    const actions = {};
    const loader = new THREE.GLTFLoader();

    AFRAME.registerComponent('my-anim', {
      init: function () {
        this.el.addEventListener('model-loaded', () => {
          model = this.el.getObject3D('mesh');
          const gltf = this.el.components['gltf-model'].model;

          mixer = new THREE.AnimationMixer(model);

          model.traverse(obj => {
            if (obj.isSkinnedMesh && obj.skeleton) {
              skeleton = obj.skeleton;
            }
          });

          gltf.animations.forEach(clip => {
            actions[clip.name] = mixer.clipAction(clip, model);
            console.log('–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è:', clip.name);
          });

          playBuiltInAnimation();
        });
      },
      tick: function (_, delta) {
        if (mixer) mixer.update(delta / 1000);
      }
    });

    function playBuiltInAnimation() {
      const clipName = Object.keys(actions)[0];
      if (!clipName) return alert("–ù–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö –∞–Ω–∏–º–∞—Ü–∏–π");

      if (currentAction) currentAction.fadeOut(0.3);
      currentAction = actions[clipName];
      currentAction.reset().fadeIn(0.3).play();
      console.log("‚ñ∂ –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∞ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è:", clipName);
    }

    function playExternalAnimation(file) {
      if (!model || !mixer || !skeleton) {
        return alert("–ú–æ–¥–µ–ª—å –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤–∞");
      }

      loader.load(`assets/${file}`, (gltf) => {
        if (!gltf.animations || gltf.animations.length === 0) {
          return alert("–ê–Ω–∏–º–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ " + file);
        }

        const clip = gltf.animations[0];
        const action = mixer.clipAction(clip);
        action._clip = clip; // –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π

        // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º animation clip –∫ —Å–∫–µ–ª–µ—Ç—É
        clip.tracks.forEach(track => {
          if (track.name.includes('mixamorig')) {
            track.name = track.name.replace(/.*?mixamorig/, `Armature|mixamorig`);
          }
        });

        if (currentAction) currentAction.fadeOut(0.3);
        currentAction = action;
        action.reset().fadeIn(0.3).play();
        console.log(`‚ñ∂ –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∞ –∞–Ω–∏–º–∞—Ü–∏—è –∏–∑ ${file}`);
      }, undefined, (error) => {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", error);
        alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ " + file);
      });
    }
  </script>
</body>
</html>
