<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>WebXR Avatar with Three.js Animation</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <!-- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ Three.js -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/loaders/GLTFLoader.min.js"></script>
    <style>
      #menu {
        position: absolute;
        top: 20px;
        left: 20px;
        background: rgba(255, 255, 255, 0.9);
        padding: 10px 15px;
        border-radius: 10px;
        font-family: sans-serif;
        z-index: 999;
      }
      button {
        display: block;
        margin: 5px 0;
        padding: 8px 12px;
        font-size: 14px;
        cursor: pointer;
      }
    </style>
  </head>

  <body>
    <div id="menu">
      <h3>–ê–Ω–∏–º–∞—Ü–∏–∏</h3>
      <button onclick="playClip('walk')">üö∂ –•–æ–¥—å–±–∞ (–∏–∑ –º–æ–¥–µ–ª–∏)</button>
      <button onclick="playClipFromGLB('pointing.glb')">üëâ –£–∫–∞–∑–∞–Ω–∏–µ</button>
      <button onclick="playClipFromGLB('arm.glb')">üëã –ú–∞—Ö–∞–Ω–∏–µ</button>
    </div>

    <a-scene loading-screen="dotsColor: black; backgroundColor: white">
      <a-assets timeout="30000">
        <a-asset-item id="walkmanModel" src="assets/walkman.glb"></a-asset-item>
      </a-assets>

      <a-entity id="avatar" gltf-model="#walkmanModel" position="0 0 -2" scale="1 1 1" my-animation></a-entity>

      <a-sky color="#ECECEC"></a-sky>
      <a-light type="ambient" intensity="1.2"></a-light>
      <a-camera position="0 1.6 0" look-controls wasd-controls></a-camera>
    </a-scene>

    <script>
      // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
      let mixer = null;
      let model = null;
      let currentAction = null;
      const actions = {};
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑—á–∏–∫–∞
      const loader = new THREE.GLTFLoader();
      
      // –§–ª–∞–≥ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
      let isModelReady = false;

      AFRAME.registerComponent("my-animation", {
        init: function () {
          this.el.addEventListener("model-loaded", () => {
            console.log("Model loaded event fired");
            
            model = this.el.getObject3D("mesh");
            if (!model) {
              console.error("Failed to get model mesh");
              return;
            }
            
            const gltf = this.el.components["gltf-model"].model;
            mixer = new THREE.AnimationMixer(model);
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∏–º–∞—Ü–∏–π –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–π –º–æ–¥–µ–ª–∏
            const clips = gltf.animations || [];
            console.log("Found animations in model:", clips);
            
            if (clips.length === 0) {
              console.warn("No animations found in the model");
            }
            
            clips.forEach((clip) => {
              // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∏–º–µ–Ω–∏ –∞–Ω–∏–º–∞—Ü–∏–∏
              const clipName = clip.name.toLowerCase();
              actions[clipName] = mixer.clipAction(clip, model);
              console.log(`Registered animation: ${clipName}`);
            });
            
            isModelReady = true;
            
            // –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∏–º–∞—Ü–∏—é walk
            playClip('walk');
          });
        },
        
        tick: function (time, delta) {
          if (mixer) {
            mixer.update(delta / 1000);
          }
        }
      });

      function playClip(name) {
        if (!isModelReady) {
          console.error("Model is not ready yet");
          setTimeout(() => playClip(name), 500);
          return;
        }
        
        const normalizedName = name.toLowerCase();
        console.log(`Trying to play animation: ${normalizedName}`);
        
        if (!actions[normalizedName]) {
          console.error(`Animation "${normalizedName}" not found. Available:`, Object.keys(actions));
          alert(`–ê–Ω–∏–º–∞—Ü–∏—è "${name}" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –º–æ–¥–µ–ª–∏.`);
          return;
        }

        if (currentAction) {
          currentAction.fadeOut(0.3);
        }

        currentAction = actions[normalizedName];
        currentAction.reset().fadeIn(0.3).play();
        console.log(`Now playing: ${normalizedName}`);
      }

      function playClipFromGLB(filename) {
        if (!isModelReady) {
          console.error("Model is not ready yet");
          setTimeout(() => playClipFromGLB(filename), 500);
          return;
        }
        
        console.log(`Loading external animation: ${filename}`);
        
        loader.load(`assets/${filename}`, 
          (gltf) => {
            if (!gltf.animations || gltf.animations.length === 0) {
              console.error(`No animations in ${filename}`);
              alert(`–§–∞–π–ª ${filename} –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∞–Ω–∏–º–∞—Ü–∏–π`);
              return;
            }
            
            const clip = gltf.animations[0];
            const clipName = clip.name || filename.replace('.glb', '');
            console.log(`Loaded animation: ${clipName}`);
            
            const action = mixer.clipAction(clip, model);
            if (!action) {
              console.error("Failed to create action");
              return;
            }
            
            if (currentAction) {
              currentAction.fadeOut(0.3);
            }
            
            currentAction = action;
            currentAction.reset().fadeIn(0.3).play();
            console.log(`Now playing external animation: ${clipName}`);
          },
          undefined,
          (error) => {
            console.error(`Error loading ${filename}:`, error);
            alert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ ${filename}`);
          }
        );
      }
    </script>
  </body>
</html>
