<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <title>–ü–µ—Ä—Å–æ–Ω–∞–∂ Tron —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-environment-component@1.3.1/dist/aframe-environment-component.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/loaders/GLTFLoader.js"></script>
    <style>
      body { margin: 0; }
      #menu {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 10;
        background: rgba(255, 255, 255, 0.9);
        padding: 10px;
        border-radius: 8px;
        font-family: sans-serif;
      }
      button {
        display: block;
        margin: 5px 0;
        padding: 6px 10px;
        font-size: 14px;
        cursor: pointer;
      }
    </style>
  </head>

  <body>
    <div id="menu">
      <h3>–ê–Ω–∏–º–∞—Ü–∏–∏</h3>
      <button onclick="playBuiltInAnimation()">‚ñ∂ –•–æ–¥—å–±–∞ (–≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è)</button>
      <button onclick="playExternalAnimation('arm.glb')">üëã –ú–∞—Ö–∞–Ω–∏–µ</button>
      <button onclick="playExternalAnimation('pointing.glb')">üëâ –£–∫–∞–∑–∞–Ω–∏–µ</button>
    </div>

    <a-scene>
      <a-assets>
        <a-asset-item id="walkman" src="assets/walk_man.glb"></a-asset-item>
      </a-assets>

      <!-- –û–∫—Ä—É–∂–µ–Ω–∏–µ Tron -->
      <a-entity environment="preset: tron; dressingAmount: 12;"></a-entity>

      <!-- –ü–µ—Ä—Å–æ–Ω–∞–∂ -->
      <a-entity id="avatar"
                gltf-model="#walkman"
                position="0 0 -2"
                scale="1 1 1"
                my-anim></a-entity>

      <a-camera position="0 1.6 2"></a-camera>
    </a-scene>

    <script>
      let mixer = null;
      let model = null;
      let currentAction = null;
      const actions = {};
      const loader = new THREE.GLTFLoader();

      AFRAME.registerComponent('my-anim', {
        init: function () {
          this.el.addEventListener('model-loaded', () => {
            model = this.el.getObject3D('mesh');
            const gltfModel = this.el.components['gltf-model'].model;

            mixer = new THREE.AnimationMixer(model);

            gltfModel.animations.forEach(clip => {
              actions[clip.name] = mixer.clipAction(clip, model);
              console.log('–í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è:', clip.name);
            });

            playBuiltInAnimation();
          });
        },
        tick: function (_, delta) {
          if (mixer) mixer.update(delta / 1000);
        }
      });

      function playBuiltInAnimation() {
        const clipName = Object.keys(actions)[0];
        if (!clipName) return alert("–ù–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏");

        if (currentAction) currentAction.fadeOut(0.3);
        currentAction = actions[clipName];
        currentAction.reset().fadeIn(0.3).play();
        console.log("‚ñ∂ –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∞ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è:", clipName);
      }

      function playExternalAnimation(file) {
        if (!model || !mixer) return alert("–ú–æ–¥–µ–ª—å –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤–∞");

        loader.load(`assets/${file}`, (gltf) => {
          const clip = gltf.animations[0];
          if (!clip) return alert("–ù–µ—Ç –∞–Ω–∏–º–∞—Ü–∏–∏ –≤ " + file);

          const action = mixer.clipAction(clip, model);

          if (currentAction) currentAction.fadeOut(0.3);
          currentAction = action;
          action.reset().fadeIn(0.3).play();

          console.log(`‚ñ∂ –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∞ –≤–Ω–µ—à–Ω—è—è –∞–Ω–∏–º–∞—Ü–∏—è –∏–∑ ${file}`);
        }, undefined, (err) => {
          console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∏–º–∞—Ü–∏–∏:", err);
          alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: " + file);
        });
      }
    </script>
  </body>
</html>
