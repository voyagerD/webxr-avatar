<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>WebXR Avatar with Three.js Animation</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/loaders/GLTFLoader.js"></script>
    <style>
      #menu {
        position: absolute;
        top: 20px;
        left: 20px;
        background: rgba(255, 255, 255, 0.9);
        padding: 10px 15px;
        border-radius: 10px;
        font-family: sans-serif;
        z-index: 999;
      }
      button {
        display: block;
        margin: 5px 0;
        padding: 8px 12px;
        font-size: 14px;
        cursor: pointer;
      }
    </style>
  </head>

  <body>
    <div id="menu">
      <h3>–ê–Ω–∏–º–∞—Ü–∏–∏</h3>
      <button onclick="playClip('walk')">üö∂ –•–æ–¥—å–±–∞ (–∏–∑ –º–æ–¥–µ–ª–∏)</button>
      <button onclick="playClipFromGLB('pointing.glb')">üëâ –£–∫–∞–∑–∞–Ω–∏–µ</button>
      <button onclick="playClipFromGLB('arm.glb')">üëã –ú–∞—Ö–∞–Ω–∏–µ</button>
    </div>

    <a-scene>
      <a-assets>
        <a-asset-item id="walkmanModel" src="assets/walkman.glb"></a-asset-item>
      </a-assets>

      <a-entity id="avatar" gltf-model="#walkmanModel" position="0 0 -2" scale="1 1 1" my-animation></a-entity>

      <a-sky color="#ECECEC"></a-sky>
      <a-light type="ambient" intensity="1.2"></a-light>
      <a-camera position="0 1.6 0" look-controls wasd-controls></a-camera>
    </a-scene>

    <script>
      let mixer, model, currentAction;
      const actions = {};
      const loader = new THREE.GLTFLoader();

      AFRAME.registerComponent("my-animation", {
        init: function () {
          this.el.addEventListener("model-loaded", () => {
            model = this.el.getObject3D("mesh");
            mixer = new THREE.AnimationMixer(model);

            // –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –∫–ª–∏–ø—ã –∏–∑ walkman.glb
            const clips = model.animations || this.el.components["gltf-model"].model.animations;
            clips.forEach((clip) => {
              actions[clip.name] = mixer.clipAction(clip);
            });

            // –ê–≤—Ç–æ—Å—Ç–∞—Ä—Ç: —Ö–æ–¥—å–±–∞
            playClip("walk");
          });
        },
        tick: function (time, delta) {
          if (mixer) mixer.update(delta / 1000);
        }
      });

      function playClip(name) {
        if (!actions[name]) {
          alert(`–ê–Ω–∏–º–∞—Ü–∏—è "${name}" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.`);
          return;
        }

        if (currentAction) {
          currentAction.fadeOut(0.3);
        }

        currentAction = actions[name];
        currentAction.reset().fadeIn(0.3).play();
      }

      function playClipFromGLB(filename) {
        if (!model || !mixer) return;

        loader.load(`assets/${filename}`, (gltf) => {
          const clip = gltf.animations[0]; // –ø–µ—Ä–≤–∞—è –∞–Ω–∏–º–∞—Ü–∏—è
          const action = mixer.clipAction(clip);

          if (currentAction) {
            currentAction.fadeOut(0.3);
          }

          currentAction = action;
          action.reset().fadeIn(0.3).play();
        });
      }
    </script>
  </body>
</html>



